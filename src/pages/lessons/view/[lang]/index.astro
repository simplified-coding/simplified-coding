---
import Layout from "../../../../layouts/Layout.astro";
import CardHeader from "../../../../components/Bootstrap/CardHeader.astro";
import {getEntry} from "astro:content";
import Language from "../../../../components/Languages/LanguageInfo.astro";
import LessonBar from "../../../../components/LessonBar.astro";

// @ts-expect-error
const entry = (await getEntry("lessons", Astro.params.lang || "js")).data;
const course = (await getEntry("lessons", "courses")).data.courses.filter(
  (c: any) => c.slug == Astro.params.lang
)[0];

const lessons = entry.data;
---

<!--
SPDX-FileCopyrightText: 2024 The Simplified Coding Team <main@simplifiedcoding.org>

SPDX-License-Identifier: GPL-3.0-only
-->
<Layout>
  <div
    class="flex justify-center p-4 text-sc-white"
    data-bs-theme="dark"
  >
    <div>
      <div>
        <Language 
        lesson_title = {course.language}
        icon = {`${course.icon}`}
        lesson_time = {course.time}
        lesson_difficulty = {course.difficulty}
        prior_knowledge = {course.prior_knowledge}
        progress = 
        >
          <br>

          <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
            <div class="bg-blue-600 h-2.5 rounded-full" id="progress-bar"></div>
          </div>

          <div
            class="progress-bar progress-bar-striped progress-bar-animated w-[0] flex" id="progress-bar-text"   
          >
            0% - 0/0 Completed
          </div>
        </Language>
      </div>
      <br/>

      <div>
        {
          lessons.map((lesson: any) => <LessonBar lesson={lesson} course={course}/>)
        }
      </div>

    </div>
  </div>

</Layout>

<script data-lesson-length={lessons.length}>
  let progressBar = document.getElementById("progress-bar");
  const progressBarText = document.getElementById("progress-bar-text");
  const lessonLength = parseInt(
    document.currentScript.getAttribute("data-lesson-length")
  );

  const currentCourse = location.pathname.split("/")[3];
  const percentage =
    (JSON.parse(localStorage.getItem(currentCourse)).length /
      lessonLength) *
    100;

  progressBar.style.width = percentage + "%";
  progressBarText.innerText = `${Math.round(percentage)}% - ${
    JSON.parse(localStorage.getItem(currentCourse)).length
  }/${lessonLength} Completed`;

  JSON.parse(localStorage.getItem(currentCourse)).forEach((course) => {
    document.getElementById(`${course}-status`).innerHTML = document
      .getElementById(`${course}-status`)
      .innerHTML += "âœ…"
  });

</script>

<script>
  import {removeLesson} from "../../../../lib/lessonTracking";

  const elements = document.getElementsByClassName("undo-completed-lesson") as HTMLCollectionOf<HTMLButtonElement>
  for (let i = 0; i < elements.length; i++) {
    elements[i].addEventListener("click", () => {
      removeLesson(elements[i].dataset.course, elements[i].dataset.lesson)
      window.location.reload()
    })
  }
</script>